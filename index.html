<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTP é›²ç«¯è²¡å‹™æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0; --text-sec: #a0a0a0; --accent: #bb86fc; --positive: #03dac6; --negative: #cf6679; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; }
        h1 { text-align: center; color: var(--accent); margin-bottom: 30px; }
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--text-sec); }
        .card .amount { font-size: 1.5rem; font-weight: bold; }
        .input-section { background-color: var(--card-bg); padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .form-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        input { background-color: #2c2c2c; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; flex: 1; }
        button { background-color: var(--accent); color: black; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .chart-container { background-color: var(--card-bg); padding: 20px; border-radius: 12px; height: 400px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background-color: var(--card-bg); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; color: var(--accent); }
        .delete-btn { background-color: var(--negative); color: white; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; }
        .loader { border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>è²¡å‹™æˆ°æƒ…å®¤</h1>
    <div class="dashboard">
        <div class="card"><h3>ç¸½è³‡ç”¢</h3><div class="amount" id="displayAssets" style="color: var(--positive)">$0</div></div>
        <div class="card"><h3>ç¸½è² å‚µ</h3><div class="amount" id="displayLiabilities" style="color: var(--negative)">$0</div></div>
        <div class="card"><h3>æ·¨è³‡ç”¢</h3><div class="amount" id="displayNetWorth">$0</div></div>
    </div>
    <div class="input-section">
        <h3 style="margin-top: 0;">ğŸ“ æ–°å¢ç´€éŒ„</h3>
        <div class="form-group">
            <input type="date" id="inputDate">
            <input type="number" id="inputAssets" placeholder="ç¸½è³‡ç”¢">
            <input type="number" id="inputLiabilities" placeholder="ç¸½è² å‚µ">
        </div>
        <button id="addBtn">ä¸Šå‚³</button>
    </div>
    <div id="loading" class="loader"></div>
    <div class="chart-container"><canvas id="financeChart"></canvas></div>
    <table id="historyTable">
        <thead><tr><th>æ—¥æœŸ</th><th>è³‡ç”¢</th><th>è² å‚µ</th><th>æ·¨è³‡ç”¢</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
// âš ï¸ æ³¨æ„ï¼šç‚ºäº†ä½¿ç”¨ await è¨ˆç®—é›œæ¹Šï¼Œæˆ‘å€‘å¿…é ˆç”¨ (async function(){ ... })(); æŠŠæ•´æ®µç¨‹å¼åŒ…èµ·ä¾†
(async function() { 

    // === ğŸ›¡ï¸ ç°¡æ˜“å¯†ç¢¼é–é–‹å§‹ (ä¿®æ­£ç‰ˆ) ===
    
    // é€™æ˜¯ä½ åŸæœ¬é‚£ä¸² SHA-256 é›œæ¹Šç¢¼
    const MY_PASSWORD_HASH = "a76631241a4ad4528be06e6f6112b7211a00cefac243a6e46e6dab61f592e861"; 

    // 1. å®šç¾©è¨ˆç®—é›œæ¹Šçš„å·¥å…·å‡½å¼
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // 2. è·³å‡ºè¼¸å…¥æ¡†
    let userPass = prompt("ğŸ”’ è«‹è¼¸å…¥æˆ°æƒ…å®¤å¯†ç¢¼ï¼š");
    
    // 3. é—œéµä¿®æ”¹ï¼šæŠŠä½ è¼¸å…¥çš„å¯†ç¢¼æ‹¿å»ç®—é›œæ¹Š (await ç­‰å¾…é‹ç®—å®Œæˆ)
    let inputHash = await sha256(userPass || ""); 

    // 4. æ¯”å°ã€Œé›œæ¹Šå€¼ã€æ˜¯å¦ç›¸åŒ
    if (inputHash !== MY_PASSWORD_HASH) {
        document.body.innerHTML = "<h1 style='color:#cf6679;text-align:center;margin-top:20%'>ğŸš« æ‹’çµ•è¨ªå•ï¼šå¯†ç¢¼éŒ¯èª¤</h1>";
        throw new Error("å¯†ç¢¼éŒ¯èª¤ï¼Œåœæ­¢åŸ·è¡Œ"); 
    }
    // === ğŸ›¡ï¸ ç°¡æ˜“å¯†ç¢¼é–çµæŸ ===


    // ... ä»¥ä¸‹æ˜¯ä½ åŸæœ¬çš„ Firebase ç¨‹å¼ç¢¼ (å®Œå…¨ä¸ç”¨å‹•) ...

    const firebaseConfig = {
        apiKey: "AIzaSyC98g3JuqPtStZ4P25YZ8trqfWpUJss3vI",
        authDomain: "financial-records-76092.firebaseapp.com",
        projectId: "financial-records-76092",
        storageBucket: "financial-records-76092.firebasestorage.app",
        messagingSenderId: "327241339058",
        appId: "1:327241339058:web:9192aecef5ccaf22ccb9ab",
        measurementId: "G-S6Z26CCGJK"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 
    const COLLECTION_NAME = "finance_records"; 

    let chart; 
    document.getElementById('inputDate').valueAsDate = new Date();
    document.getElementById('loading').style.display = 'block';

    db.collection(COLLECTION_NAME).orderBy("date", "asc")
    .onSnapshot((querySnapshot) => {
        const financeData = [];
        querySnapshot.forEach((doc) => {
            financeData.push({ id: doc.id, ...doc.data() });
        });

        document.getElementById('loading').style.display = 'none';
        renderTable(financeData);
        renderChart(financeData);
        updateDashboard(financeData);
    }, (error) => {
        console.error("è®€å–å¤±æ•—:", error);
        alert("è®€å–å¤±æ•—ï¼è«‹æª¢æŸ¥ Firebase Console Rules æˆ–æŒ‰ F12 çœ‹è©³ç´°éŒ¯èª¤ã€‚");
    });

    document.getElementById('addBtn').addEventListener('click', function() {
        const date = document.getElementById('inputDate').value;
        const assets = Number(document.getElementById('inputAssets').value);
        const liabilities = Number(document.getElementById('inputLiabilities').value);

        if (!date) { alert("è«‹é¸æ“‡æ—¥æœŸï¼"); return; }

        const btn = document.getElementById('addBtn');
        btn.disabled = true;
        btn.innerText = "ä¸Šå‚³ä¸­...";

        db.collection(COLLECTION_NAME).add({
            date: date,
            assets: assets,
            liabilities: liabilities,
            netWorth: assets - liabilities,
            timestamp: new Date()
        }).then(() => {
            console.log("å¯«å…¥æˆåŠŸ");
            document.getElementById('inputAssets').value = '';
            document.getElementById('inputLiabilities').value = '';
        }).catch((error) => {
            console.error("å¯«å…¥éŒ¯èª¤: ", error);
            alert("ä¸Šå‚³å¤±æ•—ï¼š" + error.message);
        }).finally(() => {
            btn.disabled = false;
            btn.innerText = "ä¸Šå‚³åˆ°é›²ç«¯";
        });
    });

    window.deleteData = function(id) {
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
            db.collection(COLLECTION_NAME).doc(id).delete().catch(error => {
                console.error("åˆªé™¤å¤±æ•—:", error);
                alert("åˆªé™¤å¤±æ•—");
            });
        }
    };

    function updateDashboard(data) {
        if (data.length === 0) return;
        const latest = data[data.length - 1];
        document.getElementById('displayAssets').innerText = `$${latest.assets.toLocaleString()}`;
        document.getElementById('displayLiabilities').innerText = `$${latest.liabilities.toLocaleString()}`;
        document.getElementById('displayNetWorth').innerText = `$${latest.netWorth.toLocaleString()}`;
    }

    function renderTable(data) {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        [...data].reverse().forEach(item => {
            tbody.innerHTML += `<tr><td>${item.date}</td><td style="color:var(--positive)">$${item.assets.toLocaleString()}</td><td style="color:var(--negative)">$${item.liabilities.toLocaleString()}</td><td>$${item.netWorth.toLocaleString()}</td><td><button class="delete-btn" onclick="deleteData('${item.id}')">åˆªé™¤</button></td></tr>`;
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('financeChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    { label: 'æ·¨è³‡ç”¢', data: data.map(d => d.netWorth), borderColor: '#bb86fc', backgroundColor: 'rgba(187,134,252,0.1)', fill: true },
                    { label: 'ç¸½è³‡ç”¢', data: data.map(d => d.assets), borderColor: '#03dac6', borderDash: [5,5] },
                    { label: 'ç¸½è² å‚µ', data: data.map(d => d.liabilities), borderColor: '#cf6679', borderDash: [5,5] }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { grid: { color: '#333' } }, y: { grid: { color: '#333' } } } }
        });
    }

})(); // <-- æœ€åº•ä¸‹é€™è£¡è¨˜å¾—è¦æœ‰ä¸€å°æ‹¬è™Ÿï¼Œé€™æœƒè®“ä¸Šé¢çš„ç¨‹å¼ç«‹åˆ»åŸ·è¡Œ
</script>
</body>
</html>


